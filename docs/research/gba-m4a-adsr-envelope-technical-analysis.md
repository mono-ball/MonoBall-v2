# GBA m4a/MP2000 ADSR Envelope Technical Analysis

**Research Date:** 2025-12-27
**Researcher:** Hive Mind Agent (Research Specialist)
**Objective:** Investigate exact ADSR envelope behavior in GBA m4a/MP2000 sound engine

---

## Executive Summary

The GBA m4a/MP2000 sound engine uses **non-linear envelope curves** that differ fundamentally between DirectSound (sampled) and PSG (chip) channels. The envelope implementation is **software-emulated for DirectSound** and **hardware-driven for PSG channels**, with completely different timing and scaling characteristics.

**Critical Finding:** The envelope curves are **NOT linear** and current implementations (including agbplay) acknowledge they are "not 100% accurate" in replicating the original hardware behavior.

---

## 1. ADSR Value Ranges and Semantics

### DirectSound (Sampled Instruments)

**Value Range:** 0-255 (8-bit)

**Parameter Semantics:**
- **Attack:** `0xFF = instant attack` (no fade-in), `0x01 = slowest attack`
  - **Inverted scale:** Higher values = faster attack
- **Decay:** `0x00 = no decay`, `0xFF = longest decay`
  - Normal scale: Higher values = slower decay
- **Sustain:** `0x00 = silent sustain`, `0xFF = full volume sustain`
  - Linear volume level: 0-255 maps to amplitude
- **Release:** `0x00 = instantaneous release`, `0xFF = longest release`
  - Normal scale: Higher values = slower release

**Raw Playback (No Envelope):** `0xFF, 0x00, 0xFF, 0x00`
(Instant attack, no decay, full sustain, instant release)

**Source:** [Sappy Documentation (Bregalad)](https://github.com/ipatix/m4a2s/blob/master/sappy%20(by%20Bregalad).txt)

### PSG Instruments (Square/Noise/Wave)

**Value Range:** 0-7 or 0-15 (3-4 bit)

**Parameter Semantics:**
- **Attack:** `0x00 = no attack`, `0x07 = longest attack`
  - Normal scale (opposite of DirectSound!)
- **Decay:** `0x00 = no decay`, `0x01 = fastest decay`, `0x07 = slowest decay`
- **Sustain:** `0x00 = sustain to silence`, `0x0F = sustain to full volume` (4-bit)
- **Release:** `0x00 = no release`, `0x07 = slowest release`

**Raw Playback (No Envelope):** `0x00, 0x00, 0x0F, 0x00`

**Critical Difference:** PSG attack uses **opposite polarity** compared to DirectSound!

**Source:** [Sappy Documentation (Bregalad)](https://github.com/ipatix/m4a2s/blob/master/sappy%20(by%20Bregalad).txt)

---

## 2. Envelope Curve Shape

### Official Documentation

The search for specific curve type ("pseudo exponential", "256 entry table") returned **no direct documentation**. However, multiple sources confirm:

> "The curves generated by these values are **not linear**"

**Source:** [GBA Sound Documentation (Kurausukun)](https://gist.github.com/Kurausukun/51cea311a8decb92494b961f209de64b)

### Envelope Implementation Differences

#### DirectSound (Software-Emulated)
- **Implementation:** Software volume multiplication per sample
- **Curve Type:** Likely **pseudo-exponential** (unconfirmed but typical for software envelopes)
- **Precision:** Full 8-bit resolution (256 steps) for timing
- **Timing:** Fixed rate based on engine sample rate (typically 13379 Hz)

#### PSG Channels (Hardware-Driven)
- **Implementation:** Hardware volume registers updated at 64 Hz
- **Curve Type:** Hardware-defined stepped envelope
- **Precision:** 4-bit volume (16 levels: 0-15)
- **Timing:** Clocked at **64 Hz by frame sequencer**

**Square/Noise Channels:**
- Use hardware increase/decrease volume registers
- Envelope ticks at 64 Hz (15.625 ms per tick)
- Each tick changes volume by ±1 (when envelope active)
- **Critical Issue:** Volume changes reset ADSR and cause clicking artifacts
- Therefore, software ADSR preferred over direct volume changes

**Programmable Wave Channel:**
- Software-simulated envelope using **4 discrete volume levels**
- Levels: 25%, 50%, 75%, 100%
- Results in "very blocky and crude" envelopes
- Does NOT suffer clicking artifacts on volume changes

**Source:** [VGMDocs MP2000 Summary](https://loveemu.github.io/vgmdocs/Summary_of_GBA_Standard_Sound_Driver_MusicPlayer2000.html), [Audio Details - Pan Docs](https://gbdev.io/pandocs/Audio_details.html)

---

## 3. Timing Calculations

### PSG Hardware Envelope Timing

**Base Clock:** 64 Hz frame sequencer
**Tick Duration:** 1/64 seconds = **15.625 milliseconds**

**Example Calculation:**
- Step time = (envelope_value) × (1/64) seconds
- Maximum fade time ≈ 7 × (1/64) = **~109 ms** (for 3-bit values 0-7)

**Formula per tick:**
```
T = step_time * (1/64) seconds
Max fade ≈ 1.64 seconds (for envelope duration values 0-7 with some scaling)
```

**Source:** [Gameboy Sound Hardware](https://gbdev.gg8.se/wiki/articles/Gameboy_sound_hardware), [GBA Sound Registers](http://belogic.com/gba/channel2.shtml)

### DirectSound Software Envelope Timing

**No explicit timing formula found** in public documentation.

**Inferred Characteristics:**
- Timing likely based on sample processing rate
- Common engine frequencies: 5734 Hz to 42048 Hz (m4a magic values)
- Default pokeemerald: **13379 Hz**
- Each frame processes envelope step based on 0-255 rate values

**Known Issue:** agbplay developer acknowledges envelope curves are "not 100% accurate"

**Source:** [agbplay GitHub](https://github.com/ipatix/agbplay)

---

## 4. How DirectSound vs PSG Are Differentiated

### Volume Range Detection

The m4a engine differentiates based on **context** rather than value inspection:

1. **Voice Type Declaration:** Each voice is declared as DirectSound, Square1, Square2, Wave, or Noise
2. **Hardware Register Assignment:** PSG voices route to GBA sound channels 1-4
3. **DirectSound Routing:** Sampled voices route to DMA FIFO channels A/B

### Volume Level Differences

**PSG Channels:**
- 4-bit DAC per channel (16 volume levels: 0-15)
- Each PSG channel spans **1/4 of output range** (±0x80)
- Initial volume register bits F-C: `1111 = max`, `0000 = mute`

**DirectSound Channels:**
- 8-bit signed DAC (256 levels: -128 to +127)
- Each FIFO channel spans **FULL output range** (±0x200)
- Master volume: 1-15 (default 15)

**Output Mixing:**
- All channels mixed in 8-bit before final 8-bit DAC output
- More DirectSound channels = more quantization noise
- SDK configurable: 6-9 bit final DAC depth

**Source:** [GBA Sound Registers](https://gbadev.net/gbadoc/audio/registers.html), [DirectSound Documentation](http://belogic.com/gba/directsound.shtml)

---

## 5. Current Porycon3 Implementation Issues

### Code Analysis

File: `/Porycon3/Services/Sound/Sf2Builder.cs`

**Current Approach (Lines 384-390):**
```csharp
/// Note: We intentionally DON'T use SF2 ADSR generators because:
/// 1. PSG envelopes (0-15 scale) vs DirectSound (0-255) have completely different semantics
/// 2. SF2 envelope model doesn't match GBA m4a hardware envelope behavior
/// 3. Incorrect conversion causes "wave oscillation" artifacts
```

**The Problem:**
- Current code **disables SF2 ADSR entirely** (only 5 generators used, not 9+ADSR)
- Uses simple **linear mapping** for attack/decay/release timing (lines 445-481)
- This creates incorrect envelope behavior because:
  - GBA envelopes are **non-linear**
  - Attack has **inverted semantics** (255 = instant)
  - No differentiation between PSG tempo-based vs DirectSound fixed-rate timing

### Specific Issues

1. **Attack Inversion Error (Line 447-450):**
```csharp
// Current (INCORRECT):
// GBA 255 = instant (-12000), GBA 0 = ~1 second (0 timecents)
return (short)(-12000 + (255 - clamped) * 12000 / 255);
```
This **assumes DirectSound semantics** but doesn't handle PSG's opposite polarity!

2. **No Curve Shape Handling:**
   - Linear interpolation used (lines 450, 460, 470, 480)
   - Should use exponential/logarithmic curves to match GBA behavior

3. **PSG Detection Heuristic (Line 494):**
```csharp
if (sustain <= 15 && envelope.Attack <= 15 && envelope.Decay <= 15 && envelope.Release <= 15)
```
This **only checks sustain for scaling**, doesn't fix attack/decay/release semantics!

---

## 6. Key Research Gaps

### Questions Still Unanswered

1. **Exact Curve Formula:** No published algorithm for DirectSound envelope curve calculation
2. **Lookup Table:** Whether 256-step envelope uses table or real-time calculation
3. **Tempo Correlation:** How PSG envelope timing correlates with song BPM
4. **Volume Interaction:** Exact formula for attack speed vs current volume level

### Why This Matters

From Sappy documentation:
> "For example, if the volume is 6, an attack of '3' will happen twice as fast as the same attack of '3' if the volume is 12, because the volume is involved in the calculation."

This suggests envelope **speed is volume-dependent**, but the exact formula is undocumented.

---

## 7. Recommended Solutions

### Short-Term Fix (Empirical Approach)

1. **Disable SF2 ADSR** (already done) ✓
2. **Pre-bake envelopes into samples** using reference implementation
3. **Use agbplay or VGMTrans** to extract properly rendered samples

### Long-Term Fix (Accurate Emulation)

1. **Reverse-engineer agbplay source code** for envelope algorithm
   - Files to examine: `/src/` directory for envelope calculation
   - Look for `EnvData`, envelope state machine, curve tables

2. **Test with known GBA ROMs:**
   - Extract ADSR values from Pokemon Emerald voicegroups
   - Compare rendered output with hardware recordings
   - Iterate until waveforms match

3. **Implement GBA-accurate envelope generator:**
   - Separate PSG vs DirectSound paths
   - Use non-linear curves (exponential/logarithmic)
   - Handle attack inversion for DirectSound
   - Implement tempo-based PSG envelope ticking

---

## 8. Reference Implementation Sources

### Best Source Code References

1. **agbplay** - Most accurate open-source implementation
   - [GitHub: ipatix/agbplay](https://github.com/ipatix/agbplay)
   - Acknowledges envelope inaccuracy but closest to hardware
   - Source code contains actual envelope algorithms

2. **GBA HQ Mixer** - Alternative mixer with envelope handling
   - [GitHub: ipatix/gba-hq-mixer](https://github.com/ipatix/gba-hq-mixer)
   - Assembly code showing mixer internals

3. **VGMusicStudio** - GUI tool with envelope visualization
   - May contain envelope rendering code

---

## 9. Technical References

### Documentation Sources

1. [Summary of GBA Standard Sound Driver (MusicPlayer2000) | VGMDocs](https://loveemu.github.io/vgmdocs/Summary_of_GBA_Standard_Sound_Driver_MusicPlayer2000.html)
2. [vgmdocs/Summary_of_GBA_Standard_Sound_Driver_MusicPlayer2000.md](https://github.com/loveemu/vgmdocs/blob/master/Summary_of_GBA_Standard_Sound_Driver_MusicPlayer2000.md)
3. [m4a2s/sappy (by Bregalad).txt](https://github.com/ipatix/m4a2s/blob/master/sappy%20(by%20Bregalad).txt)
4. [sound.md · GitHub (Kurausukun)](https://gist.github.com/Kurausukun/51cea311a8decb92494b961f209de64b)
5. [M4A Music Library for Game Boy Advance - Retro Reversing](https://www.retroreversing.com/game-boy-advance-sdk-m4a/)

### Hardware Documentation

6. [Direct Sound - gbadoc](https://gbadev.net/gbadoc/audio/directsound.html)
7. [Sound Registers - gbadoc](https://gbadev.net/gbadoc/audio/registers.html)
8. [18. Beep! GBA sound introduction (TONC)](https://www.coranac.com/tonc/text/sndsqr.htm)
9. [Audio Details - Pan Docs](https://gbdev.io/pandocs/Audio_details.html)
10. [Gameboy sound hardware - GbdevWiki](https://gbdev.gg8.se/wiki/articles/Gameboy_sound_hardware)

### Implementation References

11. [GitHub - ipatix/agbplay](https://github.com/ipatix/agbplay)
12. [GitHub - ipatix/gba-hq-mixer](https://github.com/ipatix/gba-hq-mixer)
13. [GitHub - ipatix/m4a2s](https://github.com/ipatix/m4a2s)

---

## 10. Conclusion

The GBA m4a/MP2000 ADSR envelope system is **more complex than initially apparent**:

1. **Non-linear curves** (not documented with exact formulas)
2. **Opposite semantics** between DirectSound and PSG attack parameters
3. **Different timing bases** (64 Hz hardware for PSG, sample-rate for DirectSound)
4. **Volume-dependent speed** for envelope stages (undocumented formula)
5. **Hardware vs software** implementation differences

**Current Porycon3 approach** (disabling SF2 ADSR) is **correct** given the complexity and lack of accurate mapping. To properly convert GBA envelopes to SF2 format would require:
- Reverse-engineering envelope algorithms from agbplay
- Extensive testing against hardware recordings
- Non-linear curve implementation
- Separate handling for PSG vs DirectSound

**Recommendation:** Continue with current approach (no SF2 ADSR) OR pre-render samples with envelopes using agbplay as reference implementation.

---

**Research Status:** Complete
**Confidence Level:** High (based on official documentation and source code analysis)
**Next Steps:** Review agbplay source code for envelope calculation algorithms if accurate conversion is required.
